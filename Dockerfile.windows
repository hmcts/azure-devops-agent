# syntax=docker/dockerfile:1
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# To make it easier for build and release pipelines to run,
# configure PowerShell execution policy
RUN powershell -Command Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey package manager with optimizations
RUN powershell -Command " \
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')); \
    choco feature enable -n allowGlobalConfirmation; \
    choco feature enable -n useRememberedArgumentsForUpgrades"

# Install essential tools and Java in a single layer to improve caching
# Group related packages together to reduce layers and enable parallel downloads
RUN choco install -y --no-progress --limit-output \
    git \
    curl \
    jq \
    powershell-core \
    azure-cli \
    unzip \
    zip \
    openjdk11 \
    openjdk17 \
    nuget.commandline

# Install Node.js with specific version in separate command to avoid version conflict
RUN choco install -y --no-progress --limit-output nodejs --version=20.11.0

# Enable corepack for yarn (separate layer as it's quick and uses npm)
RUN corepack enable && corepack prepare yarn@stable --activate

# Install .NET Framework 4.8 Developer Pack in separate layer (large download)
RUN choco install -y --no-progress netfx-4.8-devpack

# Install Visual Studio Build Tools 2022 in separate layer (largest/slowest installation)
# Using --no-progress to speed up
RUN choco install -y --no-progress visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools --add Microsoft.VisualStudio.Workload.NetCoreBuildTools --includeRecommended --quiet --wait --norestart"

# Set Java environment variables
ENV JAVA_HOME_11_X64="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_HOME_17_X64="C:\Program Files\OpenJDK\jdk-17" \
    JAVA_HOME="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

# Configure PowerShell environment variables to prevent module conflicts
ENV POWERSHELL_UPDATECHECK=Off \
    POWERSHELL_TELEMETRY_OPTOUT=1 \
    PSModulePath="C:\Program Files\PowerShell\7\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules"

# Create a comprehensive PowerShell configuration to prevent type data conflicts
# This creates both AllUsersAllHosts profiles for Windows PowerShell and PowerShell Core
RUN powershell -NoProfile -Command " \
    $profileContent = @' \
# Azure DevOps Agent PowerShell Configuration \
# Prevent type data loading conflicts \
\
# Set strict module path to prevent cross-contamination \
$env:PSModulePath = 'C:\Program Files\PowerShell\7\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules' \
\
# Disable telemetry and update checks \
$env:POWERSHELL_UPDATECHECK = 'Off' \
$env:POWERSHELL_TELEMETRY_OPTOUT = '1' \
\
# Remove problematic type data if already loaded \
$ErrorActionPreference = 'SilentlyContinue' \
$problematicTypes = @( \
    'System.Security.AccessControl.ObjectSecurity', \
    'System.Security.AccessControl.FileSystemSecurity', \
    'System.Security.AccessControl.DirectorySecurity', \
    'System.Security.AccessControl.FileSecurity', \
    'System.Security.AccessControl.RegistrySecurity' \
) \
foreach ($typeName in $problematicTypes) { \
    Remove-TypeData -TypeName $typeName -ErrorAction SilentlyContinue \
} \
$ErrorActionPreference = 'Continue' \
'@ \
    ; \
    \
    $profilePaths = @( \
        @{ \
            Path = 'C:\Windows\System32\WindowsPowerShell\v1.0\profile.ps1' \
            Name = 'Windows PowerShell AllUsersAllHosts' \
        }, \
        @{ \
            Path = 'C:\Program Files\PowerShell\7\profile.ps1' \
            Name = 'PowerShell Core AllUsersAllHosts' \
        } \
    ); \
    \
    foreach ($profile in $profilePaths) { \
        Write-Host ('Creating profile: {0}' -f $profile.Name); \
        $dir = Split-Path -Path $profile.Path -Parent; \
        if (-not (Test-Path $dir)) { \
            New-Item -Path $dir -ItemType Directory -Force | Out-Null \
        }; \
        $profileContent | Out-File -FilePath $profile.Path -Encoding utf8 -Force; \
        Write-Host ('Profile created at: {0}' -f $profile.Path) \
    }; \
    \
    Write-Host 'PowerShell profiles configured successfully' \
    "

# Note: Docker is typically accessed from the host when running Windows containers.
# If Docker in Docker is required, mount the Docker socket from the host.

WORKDIR C:/azp

COPY ./start-windows.ps1 ./start.ps1
COPY ./init-powershell.ps1 ./init-powershell.ps1
COPY ./powershell-wrapper.ps1 ./powershell-wrapper.ps1

CMD ["pwsh", "-File", ".\\start.ps1"]
