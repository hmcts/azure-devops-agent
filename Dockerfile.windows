# syntax=docker/dockerfile:1
FROM mcr.microsoft.com/windows/server:ltsc2022-amd64

# To make it easier for build and release pipelines to run,
# configure PowerShell execution policy
RUN powershell -Command Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey package manager with optimizations
RUN powershell -Command " \
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')); \
    choco feature enable -n allowGlobalConfirmation; \
    choco feature enable -n useRememberedArgumentsForUpgrades"

# Install essential tools and Java in a single layer to improve caching
# Group related packages together to reduce layers and enable parallel downloads
RUN choco install -y --no-progress --limit-output \
    git \
    curl \
    jq \
    azure-cli \
    unzip \
    zip \
    7zip \
    python \
    openjdk11 \
    openjdk17 \
    nuget.commandline \
    powershell-core \
    docker-cli \
    kubernetes-helm \
    kubernetes-cli \
    terraform \
    bicep \
    cmake \
    gitversion.portable \
    maven \
    gradle

# Install Node.js with specific version in separate command to avoid version conflict
RUN choco install -y --no-progress --limit-output nodejs --version=20.11.0

# Enable corepack for yarn (separate layer as it's quick and uses npm)
RUN corepack enable && corepack prepare yarn@stable --activate

# Install .NET Framework 4.8 Developer Pack in separate layer (large download)
RUN choco install -y --no-progress netfx-4.8-devpack

# Install SQL Server tools for database deployments
RUN choco install -y --no-progress sqlpackage

# Install Visual Studio Build Tools 2022 in separate layer (largest/slowest installation)
# Using --no-progress to speed up
# Added Microsoft.VisualStudio.Component.TestTools.BuildTools for MSTest framework support
# Added Microsoft.VisualStudio.Workload.WebBuildTools for ASP.NET web application build support
# Added Microsoft.Net.Component.4.TargetingPack for older .NET Framework targeting packs
# Added Microsoft.VisualStudio.Component.NuGet.BuildTools for NuGet restore during build
RUN choco install -y --no-progress visualstudio2022buildtools --package-parameters " \
    --add Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools \
    --add Microsoft.VisualStudio.Workload.NetCoreBuildTools \
    --add Microsoft.VisualStudio.Workload.WebBuildTools \
    --add Microsoft.VisualStudio.Component.TestTools.BuildTools \
    --add Microsoft.Component.MSBuild \
    --add Microsoft.Net.Component.4.8.SDK \
    --add Microsoft.Net.Component.4.8.TargetingPack \
    --add Microsoft.Net.ComponentGroup.4.8.DeveloperTools \
    --add Microsoft.VisualStudio.Component.NuGet.BuildTools \
    --add Microsoft.VisualStudio.Component.Roslyn.Compiler \
    --add Microsoft.VisualStudio.Component.TextTemplating \
    --includeRecommended \
    --quiet \
    --wait \
    --norestart"

# Install MSTest v2 globally via NuGet (compatibility layer for projects still using MSTest v1)
# This makes the modern MSTest assemblies available system-wide
RUN powershell -Command " \
    nuget install MSTest.TestFramework -Version 3.1.1 -OutputDirectory C:\MSTest; \
    nuget install MSTest.TestAdapter -Version 3.1.1 -OutputDirectory C:\MSTest; \
    Write-Host 'MSTest v2 installed successfully'"

# Install Entity Framework 6 command-line tools for migrations
RUN powershell -Command " \
    nuget install EntityFramework -Version 6.5.1 -OutputDirectory C:\EF6; \
    Write-Host 'Entity Framework 6 installed successfully'"

# Set environment variable to help MSBuild find MSTest assemblies
ENV MSTEST_PATH="C:\MSTest"

# Add EF6 to PATH so ef6.exe is available for running migrations
ENV PATH="C:\EF6\EntityFramework.6.5.1\tools;${PATH}"

# Set Java environment variables
ENV JAVA_HOME_11_X64="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_HOME_17_X64="C:\Program Files\OpenJDK\jdk-17" \
    JAVA_HOME="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

WORKDIR C:/azp

COPY ./start-windows.ps1 ./start.ps1

CMD ["powershell", "-File", ".\\start.ps1"]

