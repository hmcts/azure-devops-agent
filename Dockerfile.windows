# syntax=docker/dockerfile:1
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# To make it easier for build and release pipelines to run,
# configure PowerShell execution policy
RUN powershell -Command Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey package manager with optimizations
RUN powershell -Command " \
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')); \
    choco feature enable -n allowGlobalConfirmation; \
    choco feature enable -n useRememberedArgumentsForUpgrades"

# Install essential tools and Java in a single layer to improve caching
# Group related packages together to reduce layers and enable parallel downloads
RUN choco install -y --no-progress --limit-output \
    git \
    curl \
    jq \
    powershell-core \
    azure-cli \
    unzip \
    zip \
    openjdk11 \
    openjdk17 \
    nuget.commandline

# Install Node.js with specific version in separate command to avoid version conflict
RUN choco install -y --no-progress --limit-output nodejs --version=20.11.0

# Enable corepack for yarn (separate layer as it's quick and uses npm)
RUN corepack enable && corepack prepare yarn@stable --activate

# Install .NET Framework 4.8 Developer Pack in separate layer (large download)
RUN choco install -y --no-progress netfx-4.8-devpack

# Install Visual Studio Build Tools 2022 in separate layer (largest/slowest installation)
# Using --no-progress to speed up
RUN choco install -y --no-progress visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools --add Microsoft.VisualStudio.Workload.NetCoreBuildTools --includeRecommended --quiet --wait --norestart"

# Set Java environment variables
ENV JAVA_HOME_11_X64="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_HOME_17_X64="C:\Program Files\OpenJDK\jdk-17" \
    JAVA_HOME="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

# Configure PowerShell to prevent module conflicts
# Set PSModulePath to ensure proper module resolution order
ENV PSModulePath="C:\Program Files\PowerShell\7\Modules;C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules" \
    __PSDisableTypeDataLoading=1 \
    POWERSHELL_UPDATECHECK=Off \
    POWERSHELL_TELEMETRY_OPTOUT=1

# Create PowerShell profile to prevent module conflicts in agent tasks
# This runs for both PowerShell Core and Windows PowerShell
RUN powershell -Command " \
    $profileContent = '# Azure DevOps Agent PowerShell Configuration' + [Environment]::NewLine + \
    '$ErrorActionPreference = ''SilentlyContinue''' + [Environment]::NewLine + \
    'try {' + [Environment]::NewLine + \
    '    Remove-TypeData -TypeName ''System.Security.AccessControl.ObjectSecurity'' -ErrorAction SilentlyContinue' + [Environment]::NewLine + \
    '} catch { }' + [Environment]::NewLine + \
    '$ErrorActionPreference = ''Continue''' + [Environment]::NewLine + \
    '$env:PSModulePath = ''C:\Program Files\PowerShell\7\Modules;C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules'''; \
    $profilePaths = @( \
        'C:\Windows\System32\WindowsPowerShell\v1.0\profile.ps1', \
        'C:\Program Files\PowerShell\7\profile.ps1' \
    ); \
    foreach ($path in $profilePaths) { \
        $dir = Split-Path -Path $path -Parent; \
        if (-not (Test-Path $dir)) { \
            New-Item -Path $dir -ItemType Directory -Force | Out-Null \
        }; \
        $profileContent | Out-File -FilePath $path -Encoding utf8 -Force \
    } \
    "

# Create a Types.ps1xml override file to prevent duplicate type definitions
RUN powershell -Command " \
    $typesOverride = '<?xml version=' + [char]34 + '1.0' + [char]34 + ' encoding=' + [char]34 + 'utf-8' + [char]34 + '?>' + [Environment]::NewLine + \
    '<Types>' + [Environment]::NewLine + \
    '    <!-- Empty types file to prevent duplicate loading -->' + [Environment]::NewLine + \
    '</Types>'; \
    $typesPath = 'C:\Windows\System32\WindowsPowerShell\v1.0\Types.Custom.ps1xml'; \
    $typesOverride | Out-File -FilePath $typesPath -Encoding utf8 -Force \
    "

# Note: Docker is typically accessed from the host when running Windows containers.
# If Docker in Docker is required, mount the Docker socket from the host.

WORKDIR C:/azp

COPY ./start-windows.ps1 ./start.ps1
COPY ./init-powershell.ps1 ./init-powershell.ps1

CMD ["pwsh", "-File", ".\\start.ps1"]
