FROM mcr.microsoft.com/windows/servercore:ltsc2022

# To make it easier for build and release pipelines to run,
# configure PowerShell execution policy
RUN powershell -Command Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey package manager
RUN powershell -Command " \
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"

# Install essential tools
RUN choco install -y \
    git \
    curl \
    jq \
    powershell-core \
    azure-cli \
    unzip \
    zip

# Install Node.js
RUN choco install -y nodejs --version=20.11.0

# Enable corepack for yarn
RUN corepack enable && corepack prepare yarn@stable --activate

# Install Java OpenJDKs
RUN choco install -y openjdk11 openjdk17

# Install .NET Framework 4.8 Developer Pack
RUN choco install -y netfx-4.8-devpack

# Install Visual Studio Build Tools 2022 with .NET desktop build tools
# This includes MSBuild, .NET Framework targeting packs, and other build tools
RUN choco install -y visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools --add Microsoft.VisualStudio.Workload.NetCoreBuildTools --includeRecommended --quiet --wait"

# Install NuGet CLI
RUN choco install -y nuget.commandline

# Set Java environment variables
ENV JAVA_HOME_11_X64="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_HOME_17_X64="C:\Program Files\OpenJDK\jdk-17" \
    JAVA_HOME="C:\Program Files\OpenJDK\jdk-11" \
    JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

# Configure PowerShell to prevent module conflicts
# Set PSModulePath to ensure proper module resolution order
ENV PSModulePath="C:\Program Files\PowerShell\7\Modules;C:\Program Files\WindowsPowerShell\Modules;C:\Windows\system32\WindowsPowerShell\v1.0\Modules"

# Disable automatic loading of custom type data to prevent conflicts
# This prevents the "member already present" errors
ENV __PSDisableTypeDataLoading=1

# Create PowerShell profile to prevent module conflicts in agent tasks
RUN powershell -Command " \
    $profilePath = 'C:\Windows\System32\WindowsPowerShell\v1.0\profile.ps1'; \
    New-Item -Path $profilePath -Force | Out-Null; \
    @' \
`$ErrorActionPreference = ''Continue'' \
# Prevent duplicate type data loading \
if (-not `$env:__PSDisableTypeDataLoading) { `$env:__PSDisableTypeDataLoading = ''1'' } \
'@ | Out-File -FilePath `$profilePath -Encoding utf8 \
    "

# Note: Docker is typically accessed from the host when running Windows containers.
# If Docker in Docker is required, mount the Docker socket from the host.

WORKDIR C:/azp

COPY ./start-windows.ps1 ./start.ps1

CMD ["pwsh", "-File", ".\\start.ps1"]
